{"version":3,"file":"withUnimodules.js","sourceRoot":"","sources":["../../src/addons/withUnimodules.ts"],"names":[],"mappings":"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","sourcesContent":["import { getPossibleProjectRoot } from '@expo/config/paths';\nimport path from 'path';\nimport { ExternalsFunctionElement } from 'webpack';\n\nimport {\n  getAliases,\n  getConfig,\n  getMode,\n  getModuleFileExtensions,\n  getPaths,\n  getPublicPaths,\n  validateEnvironment,\n} from '../env';\nimport { createBabelLoader, createFontLoader } from '../loaders';\n// importing from \"../plugins\" will cause dependency issues with next-adapter\n// other plugins import webpack4 packages which error on load when next-adapter uses webpack5\nimport ExpoDefinePlugin from '../plugins/ExpoDefinePlugin';\nimport { AnyConfiguration, Arguments, Environment, InputEnvironment } from '../types';\nimport { rulesMatchAnyFiles } from '../utils';\nimport withAlias from './withAlias';\nimport withEntry from './withEntry';\n\n/**\n * Wrap your existing webpack config with support for Unimodules.\n * ex: Storybook `({ config }) => withUnimodules(config)`\n *\n * @param webpackConfig Optional existing Webpack config to modify.\n * @param env Optional Environment options for configuring what features the Webpack config supports.\n * @param argv\n * @category addons\n */\nexport default function withUnimodules(\n  webpackConfig: AnyConfiguration = {},\n  env: InputEnvironment = {},\n  argv: Arguments = {}\n): AnyConfiguration {\n  // @ts-ignore: We should attempt to use the project root that the other config is already using (used for Gatsby support).\n  env.projectRoot = env.projectRoot || webpackConfig.context || getPossibleProjectRoot();\n\n  // Add native react aliases\n  webpackConfig = withAlias(webpackConfig, getAliases(env.projectRoot));\n\n  const isWebpack5 = argv.webpack5;\n\n  if (!webpackConfig.module) webpackConfig.module = { rules: [] };\n  else if (!webpackConfig.module.rules)\n    webpackConfig.module = { ...webpackConfig.module, rules: [] };\n\n  if (!webpackConfig.plugins) webpackConfig.plugins = [];\n  if (!webpackConfig.resolve) webpackConfig.resolve = {};\n  if (!webpackConfig.output) webpackConfig.output = {};\n\n  // Attempt to use the input webpack config mode\n  env.mode = env.mode || webpackConfig.mode;\n\n  const environment: Environment = validateEnvironment(env);\n\n  let { supportsFontLoading } = argv;\n\n  // If the args don't specify this then we'll check if the input already supports font loading.\n  if (typeof supportsFontLoading === 'undefined') {\n    const supportedFonts = ['ttf', 'otf', 'woff', 'woff2', 'eot'];\n    const testFontFileNames = supportedFonts.map(ext =>\n      path.resolve(environment.projectRoot, `cool-font.${ext}`)\n    );\n    if (rulesMatchAnyFiles(webpackConfig, testFontFileNames)) {\n      supportsFontLoading = false;\n    }\n  }\n\n  const { platform = 'web' } = env;\n\n  const config = argv.expoConfig || getConfig(environment);\n\n  const mode = getMode(env);\n  const locations = env.locations || getPaths(environment.projectRoot, environment);\n\n  const { build: buildConfig = {} } = config.web || {};\n  const { babel: babelAppConfig = {} } = buildConfig;\n\n  const babelProjectRoot = babelAppConfig.root || locations.root;\n\n  const babelLoader = createBabelLoader({\n    projectRoot: locations.root,\n    mode,\n    platform,\n    babelProjectRoot,\n    verbose: babelAppConfig.verbose,\n    include: [\n      ...(babelAppConfig.include || []),\n      ...(env.babel?.dangerouslyAddModulePathsToTranspile || []),\n    ],\n    use: babelAppConfig.use,\n  });\n\n  function reuseOrCreatePublicPaths() {\n    if (webpackConfig.output && webpackConfig.output.publicPath) {\n      const publicPath = webpackConfig.output.publicPath;\n      return {\n        publicPath,\n        publicUrl: publicPath.endsWith('/') ? publicPath.slice(0, -1) : publicPath,\n      };\n    }\n    return getPublicPaths(environment);\n  }\n\n  const { publicPath, publicUrl } = reuseOrCreatePublicPaths();\n\n  webpackConfig.mode = mode;\n\n  webpackConfig.output = {\n    // This is the URL that app is served from.\n    // We use \"/\" in development.\n    ...webpackConfig.output,\n    publicPath,\n  };\n\n  webpackConfig.plugins.push(\n    // Used for surfacing information related to constants\n    new ExpoDefinePlugin({\n      mode,\n      publicUrl,\n      config,\n    })\n  );\n\n  const rules = [\n    ...webpackConfig.module.rules,\n\n    // TODO: Bacon: Auto remove this loader\n    {\n      test: /\\.html$/,\n      use: ['html-loader'],\n      exclude: locations.template.folder,\n    },\n    // Process application code with Babel.\n    babelLoader,\n\n    supportsFontLoading && createFontLoader(locations.root, locations.includeModule),\n  ].filter(Boolean);\n\n  webpackConfig.module = {\n    ...webpackConfig.module,\n    rules,\n  };\n\n  webpackConfig.resolve = {\n    ...webpackConfig.resolve,\n    symlinks: false,\n    // Support platform extensions like .web.js\n    extensions: getModuleFileExtensions('web'),\n  };\n\n  // Transpile and remove expo modules from Next.js externals.\n  const includeFunc = babelLoader.include as (path: string) => boolean;\n  webpackConfig = ignoreExternalModules(webpackConfig, includeFunc, isWebpack5);\n\n  // Add a loose requirement on the ResizeObserver polyfill if it's installed...\n  webpackConfig = withEntry(webpackConfig, env, {\n    entryPath: 'resize-observer-polyfill/dist/ResizeObserver.global',\n  });\n\n  return webpackConfig;\n}\n\n/**\n * We have to transpile these modules and make them not external too.\n * We have to do this because next.js by default externals all `node_modules`'s js files.\n *\n * Reference:\n * - https://github.com/martpie/next-transpile-modules/blob/77450a0c0307e4b650d7acfbc18641ef9465f0da/index.js#L48-L62\n * - https://github.com/zeit/next.js/blob/0b496a45e85f3c9aa3cf2e77eef10888be5884fc/packages/next/build/webpack-config.ts#L185-L258\n * - `include` function is from https://github.com/expo/expo-cli/blob/3933f3d6ba65bffec2738ece71b62f2c284bd6e4/packages/webpack-config/webpack/loaders/createBabelLoaderAsync.js#L76-L96\n *\n * @param webpackConfig Config to be modified\n * @param shouldIncludeModule A method that returns a boolean when the input module should be transpiled and externed.\n */\nexport function ignoreExternalModules(\n  webpackConfig: AnyConfiguration,\n  shouldIncludeModule: (path: string) => boolean,\n  isWebpack5: boolean\n): AnyConfiguration {\n  if (!webpackConfig.externals) {\n    return webpackConfig;\n  }\n  if (!Array.isArray(webpackConfig.externals)) {\n    webpackConfig.externals = [webpackConfig.externals];\n  }\n  webpackConfig.externals = webpackConfig.externals.map(external => {\n    if (typeof external !== 'function') {\n      return external;\n    }\n\n    if (isWebpack5) {\n      return (ctx => {\n        const relPath = path.join('node_modules', ctx.request);\n        return shouldIncludeModule(relPath) ? undefined : (external as (content: any) => any)(ctx);\n      }) as ExternalsFunctionElement;\n    }\n\n    return ((ctx, req, cb) => {\n      const relPath = path.join('node_modules', req);\n      return shouldIncludeModule(relPath) ? cb() : external(ctx, req, cb);\n    }) as ExternalsFunctionElement;\n  });\n\n  return webpackConfig;\n}\n"]}